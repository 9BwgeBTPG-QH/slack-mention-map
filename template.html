<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Slackメンション関係 サンキーダイアグラム</title>
    <script src="https://cdn.plot.ly/plotly-2.29.1.min.js"></script>
    <style>
        body {
            font-family: "Hiragino Kaku Gothic Pro", "メイリオ", Meiryo, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1250px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #1D9BD1;
            text-align: center;
        }
        .info {
            margin-bottom: 20px;
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 4px;
        }
        #sankey {
            width: 100%;
            height: 750px;
        }
        .button-container {
            margin: 15px 0;
            text-align: center;
            position: relative;
            z-index: 100;
        }
        .btn {
            background-color: #1D9BD1;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 0 5px;
            transition: all 0.3s ease;
        }
        .btn:hover {
            background-color: #0F7AB7;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .btn-help {
            background-color: #5cb85c;
        }
        .btn-help:hover {
            background-color: #449d44;
        }
        .legend {
            display: flex;
            justify-content: center;
            margin: 15px 0;
            flex-wrap: wrap;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin: 0 15px;
        }
        .legend-color {
            width: 20px;
            height: 20px;
            margin-right: 5px;
            border: 1px solid #ddd;
        }
        .footer {
            margin-top: 20px;
            text-align: center;
            font-size: 12px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Slackメンション関係 サンキーダイアグラム</h1>
        <div class="button-container">
            <button id="download" class="btn">画像をダウンロード</button>
            <button id="help" class="btn btn-help">使い方を見る</button>
        </div>
        <div class="legend">
            <div class="legend-item">
                <div class="legend-color" style="background-color: rgba(100, 149, 237, 0.8);"></div>
                <span>送信者</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: rgba(147, 112, 219, 0.8);"></div>
                <span>送受信両方</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: rgba(255, 165, 0, 0.8);"></div>
                <span>受信者</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: rgba(180, 180, 180, 0.8);"></div>
                <span>メンションなし</span>
            </div>
        </div>
        <div class="info" id="info">データを読み込み中...</div>
        <div id="sankey"></div>
        <div class="footer">
            このサンキーダイアグラムは対話型です。ノードをドラッグして移動したり、ホバーして詳細を表示できます。
        </div>
    </div>

    <script>
        // ヘルプモーダルを表示する関数
        const showGuide = () => {
            const modal = document.createElement('div');
            modal.style.position = 'fixed';
            modal.style.top = '50%';
            modal.style.left = '50%';
            modal.style.transform = 'translate(-50%, -50%)';
            modal.style.background = 'white';
            modal.style.padding = '20px';
            modal.style.borderRadius = '8px';
            modal.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
            modal.style.zIndex = '1000';
            modal.style.maxWidth = '600px';
            modal.style.maxHeight = '80vh';
            modal.style.overflow = 'auto';
            
            modal.innerHTML = `
                <h3 style="margin-top:0">サンキーダイアグラムの使い方</h3>
                <p><strong>ノードの色分け</strong>:</p>
                <ul>
                    <li><span style="color:cornflowerblue">青色</span>: 主に送信者（メンションをした人）</li>
                    <li><span style="color:blueviolet">紫色</span>: 送信と受信の両方を行った人</li>
                    <li><span style="color:orange">オレンジ色</span>: 主に受信者（メンションされた人）</li>
                    <li><span style="color:gray">グレー</span>: メンションなし（N/A）</li>
                </ul>
                <p><strong>操作方法</strong>:</p>
                <ul>
                    <li>ノードをドラッグして自由に配置できます</li>
                    <li>マウスを重ねると詳細情報が表示されます</li>
                    <li>「画像をダウンロード」ボタンで保存できます</li>
                </ul>
                <p><strong>ヒント</strong>:</p>
                <ul>
                    <li>見やすい配置になるようノードを整理してみましょう</li>
                    <li>関連性の強いノード同士を近くに配置すると分かりやすくなります</li>
                    <li>特に太い線に注目すると主要なコミュニケーションの流れが分かります</li>
                </ul>
                <button id="close-modal" style="padding:8px 16px; background:#1D9BD1; color:white; border:none; border-radius:4px; cursor:pointer; float:right">閉じる</button>
                <div style="clear:both"></div>
            `;
            
            document.body.appendChild(modal);
            
            document.getElementById('close-modal').addEventListener('click', () => {
                modal.remove();
            });
            
            // 任意の場所をクリックしても閉じられるように
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        };
    
        // データをフェッチする
        fetch('/data')
            .then(response => response.json())
            .then(data => {
                // 情報テキストを更新
                document.getElementById('info').textContent = 
                    `チャンネル: #${data.channel_name} / 期間: 過去${data.days}日間 / 生成日時: ${new Date(data.timestamp * 1000).toLocaleString()}`;
                
                const mentionData = data.mention_data;
                
                // 送信者と受信者のリストを作成
                const senders = new Set();
                const receivers = new Set();
                const links = [];
                const values = [];
                const colors = [];

                // カラーパレットの生成（送信者ごとに異なる色を割り当て）
                function generateColor(index, total) {
                    const hue = (index / total) * 360;
                    return `hsla(${hue}, 70%, 50%, 0.6)`;
                }

                // データの整理
                Object.entries(mentionData).forEach(([sender, receiverData]) => {
                    senders.add(sender);
                    Object.entries(receiverData).forEach(([receiver, count]) => {
                        receivers.add(receiver);
                        links.push([sender, receiver]);
                        values.push(count);
                    });
                });

                // 送信者と受信者の配列を作成
                const senderArray = Array.from(senders);
                const receiverArray = Array.from(receivers);

                // ノードの作成
                const nodes = [
                    ...senderArray.map(name => ({ name: name })),
                    ...receiverArray.map(name => ({ name: name }))
                ];

                // リンクの作成とカラーの割り当て
                const link_data = links.map(([source, target], i) => ({
                    source: senderArray.indexOf(source),
                    target: senderArray.length + receiverArray.indexOf(target),
                    value: values[i],
                    color: generateColor(senderArray.indexOf(source), senderArray.length)
                }));

                // Sankeyダイアグラムのデータ
                const plotData = [{
                    type: "sankey",
                    orientation: "h",
                    node: {
                        pad: 15,
                        thickness: 20,
                        line: {
                            color: "black",
                            width: 0.5
                        },
                        label: nodes.map(n => n.name),
                        x: [...Array(senderArray.length).fill(0), ...Array(receiverArray.length).fill(1)],
                        y: [
                            ...Array(senderArray.length).fill().map((_, i) => i / (senderArray.length - 1 || 1)),
                            ...Array(receiverArray.length).fill().map((_, i) => i / (receiverArray.length - 1 || 1))
                        ],
                        color: nodes.map((_, i) => 
                            i < senderArray.length ? "rgba(100, 149, 237, 0.8)" : "rgba(255, 165, 0, 0.8)"
                        )
                    },
                    link: {
                        source: link_data.map(d => d.source),
                        target: link_data.map(d => d.target),
                        value: link_data.map(d => d.value),
                        color: link_data.map(d => d.color)
                    }
                }];

                // レイアウトの設定
                const layout = {
                    title: {
                        text: `チャンネル #${data.channel_name} のメンション関係（過去${data.days}日間）`,
                        font: {
                            size: 20,
                            family: "Hiragino Kaku Gothic Pro, メイリオ, sans-serif"
                        }
                    },
                    width: 1200,
                    height: 800,
                    font: {
                        size: 12,
                        family: "Hiragino Kaku Gothic Pro, メイリオ, sans-serif"
                    },
                    paper_bgcolor: 'rgba(255,255,255,1)',
                    plot_bgcolor: 'rgba(255,255,255,1)',
                };

                // プロット作成
                Plotly.newPlot('sankey', plotData, layout);
                
                // ダウンロードボタンの設定
                document.getElementById('download').addEventListener('click', function() {
                    Plotly.downloadImage('sankey', {
                        format: 'png',
                        filename: `slack_mentions_${data.channel_name}`,
                        width: 1200,
                        height: 800,
                        scale: 2
                    });
                });
                
                // ヘルプボタンの設定
                document.getElementById('help').addEventListener('click', showGuide);
                
                // 最初にガイドを表示
                setTimeout(showGuide, 1000);
            })
            .catch(error => {
                console.error('データ取得エラー:', error);
                document.getElementById('info').textContent = 'エラー: データの読み込みに失敗しました';
            });
    </script>
</body>
</html>
